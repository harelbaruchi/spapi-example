(()=>{"use strict";var e={n:t=>{var a=t&&t.__esModule?()=>t.default:()=>t;return e.d(a,{a}),a},d:(t,a)=>{for(var r in a)e.o(a,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:a[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{AmzRegister:()=>y,AmzShipments:()=>I,GetProductIncludedData:()=>k,LabelType:()=>d,MarketplaceCountries:()=>g,PageType:()=>m,isGetLabelsParams:()=>s,lowerCaseKeys:()=>p,validateGetProductParams:()=>c,validateGetProductsParams:()=>l,validateGetShipmentListParams:()=>i,validateGetShipmentProductsParams:()=>o,validateProperty:()=>n});const a=require("amazon-sp-api");var r=e.n(a);function n(e){return"string"==typeof e?!(!e||e.length<1):"number"==typeof e&&!(!e||void 0===e)}function i(e){if(!e||void 0===e)throw new Error("cannot resolve shipments without parameters");if(!((t=e.filters.byDateRange)&&"object"==typeof t&&"start"in t&&"end"in t&&"number"==typeof t.end&&"number"==typeof t.start))throw new Error("cannot resolve shipment List, Date range invalid");var t;if(!n(e.credentials.refreshToken))throw new Error("cannot relosve client without valid refresh token");if(!n(e.marketplaceCountry))throw new Error("cannot resolve marketplace country")}function s(e){return e&&"object"==typeof e&&"credentials"in e&&"refreshToken"in e.credentials&&"marketplaceCountry"in e&&"shipmentId"in e&&"pageType"in e&&"labelType"in e}function o(e){if(!n(e.shipmentId))throw new Error("parameter shipmentId is missing");if(void 0===e.marketplaceCountry)throw new Error("parameter marketplaceCountry is missing");if(!n(e.credentials.refreshToken))throw new Error("parameter refreshToken is missing")}function l(e){if(!e.marketplaceSkus)throw new Error("parameter marketplaceSkus is missing");if(void 0===e.marketplaceCountry)throw new Error("parameter marketplaceCountry is missing");if(!n(e.credentials.refreshToken))throw new Error("parameter refreshToken is missing")}function c(e){if(!n(e.marketplaceSku))throw new Error("parameter marketplaceSku is missing ");if(void 0===e.marketplaceCountry)throw new Error("parameter marketplaceCountry is missing");if(!n(e.credentials.refreshToken))throw new Error("parameter refreshToken is missing")}function p(e){if("object"!=typeof e)return e;if(Array.isArray(e))return e.map(p);if(null===e)return null;const t=Object.entries(e).map((([e,t])=>[`${e.substring(0,1).toLowerCase()}${e.substring(1)}`,p(t)]));return Object.fromEntries(t)}let u,m,d,g,k;!function(e){e[e.PARENT=0]="PARENT",e[e.CHILD=1]="CHILD"}(u||(u={})),function(e){e.packageLabelLetter2="PackageLabel_Letter_2",e.packageLabelLetter4="PackageLabel_Letter_4",e.packageLabelLetter6="PackageLabel_Letter_6",e.packageLabelLetter6CarrierLeft="PackageLabel_Letter_6_CarrierLeft",e.packageLabelA42="PackageLabel_A4_2",e.packageLabelA44="PackageLabel_A4_4",e.packageLabelPlainPaper="PackageLabel_Plain_Paper",e.packageLabelPlainPaperCarrierBotton="PackageLabel_Plain_Paper_CarrierBottom",e.packageLabelThermal="PackageLabel_Thermal",e.packageLabelThermalUnified="PackageLabel_Thermal_Unified",e.packageLabelThermalNonPcp="PackageLabel_Thermal_NonPCP",e.packageLabelThermalNoCarrierRotation="PackageLabel_Thermal_No_Carrier_Rotation"}(m||(m={})),function(e){e.barcode2d="BARCODE_2D",e.unique="UNIQUE",e.pallet="PALLET"}(d||(d={})),function(e){e.US="us",e.CA="ca",e.MX="mx"}(g||(g={})),function(e){e.summaries="summaries",e.variations="variations",e.productTypes="productTypes",e.identifiers="identifiers",e.salesRanks="salesRanks",e.images="images"}(k||(k={}));const f={us:"ATVPDKIKX0DER",ca:"A2EUQ1WTGCTBG2",mx:"A1AM78C64UM0Y8"},h=["CANCELLED","CHECKED_IN","CLOSED","DELETED","DELIVERED","ERROR","IN_TRANSIT","RECEIVING","SHIPPED","WORKING"];g.US,g.CA,g.MX;class y{constructor(e){this.sellingPartner=void 0,this.sellingPartner=new(r())({region:"na",options:{only_grantless_operations:!0},credentials:{AWS_SELLING_PARTNER_ROLE:e.awsSellingPartnerRole,AWS_SECRET_ACCESS_KEY:e.awsSecretAccessKey,AWS_ACCESS_KEY_ID:e.awsAccessKeyId,SELLING_PARTNER_APP_CLIENT_SECRET:e.sellingPartnerAppClientSecret,SELLING_PARTNER_APP_CLIENT_ID:e.sellingPartnerAppClientId}})}static getConsentURL(e){if(!e)throw new Error("no object was detected");if("object"!=typeof e)throw new Error("expected argument of the type: object but received "+typeof e);if(!e.userToken||!n(e.userToken))throw new Error("userToken is missing or empty");let t=e.url?e.url:"https://sellercentral.amazon.com/apps/authorize/consent?application_id=",a=e.appId?e.appId:"amzn1.sp.solution.cf477399-1e16-4da0-b64f-9a62e8ef12fd",r=e.version?e.version:"beta";return`${t}${a}&state=${e.userToken}&version=${r}`}async getRefreshToken(e){if(!e||!0!==n(e))throw new Error("Authentication code cannot be empty nor "+typeof e);return(await this.sellingPartner.exchange(e)).refresh_token}}const b=require("nano-memoize"),P="2020-12-01",_=["summaries","variations","productTypes","identifiers","salesRanks","images"],L=["attributes","summaries","variations","productTypes","identifiers","salesRanks","images"],S="catalogItems.getCatalogItem";class I{_initSellingPartnerObject(e){return T(e)}_getMarketplaceId(e){const t=[];return t.push(f[e]),t}async getShipmentList(e){i(e);const t=this._initSellingPartnerObject(e.credentials.refreshToken),a=e.filters,r=new Date(a.byDateRange.end),n=new Date(a.byDateRange.start);return p(await t.callAPI({operation:"fulfillmentInbound.getShipments",query:{MarketplaceId:this._getMarketplaceId(e.marketplaceCountry),QueryType:"DATE_RANGE",LastUpdatedBefore:r,LastUpdatedAfter:n,ShipmentStatusList:a.byStatus?a.byStatus:h}})).shipmentData}async getProduct(e){c(e);const t=this._initSellingPartnerObject(e.credentials.refreshToken),a={operation:S,query:{marketplaceIds:this._getMarketplaceId(e.marketplaceCountry)}};return Object.assign(a,{options:{version:P},path:{asin:e.marketplaceSku}}),Object.assign(a.query,{includedData:e.includedData?e.includedData:_}),await t.callAPI(a)}async getProducts(e,t){l(e);const a=this._initSellingPartnerObject(e.credentials.refreshToken),r={operation:"catalogItems.searchCatalogItems",query:{marketplaceIds:this._getMarketplaceId(e.marketplaceCountry)}};Object.assign(r,{options:{version:P}}),Object.assign(r.query,{keywords:e.marketplaceSkus,includedData:e.includedData?e.includedData:_,pageSize:20}),t&&Object.assign(r.query,{pageToken:t});const n=await a.callAPI(r);let i=n.items;if(n.pagination.nextToken){const t=await this.getProducts(e,n.pagination.nextToken);i=i.concat(t)}return i}async getProductAttributes(e){c(e);const t=this._initSellingPartnerObject(e.credentials.refreshToken),a={operation:S,query:{marketplaceIds:this._getMarketplaceId(e.marketplaceCountry)}};return Object.assign(a,{options:{version:P},path:{asin:e.marketplaceSku}}),Object.assign(a.query,{includedData:L}),await t.callAPI(a)}async getShipmentProducts(e){o(e);const t=this._initSellingPartnerObject(e.credentials.refreshToken),a=p(await t.callAPI({operation:"fulfillmentInbound.getShipmentItemsByShipmentId",path:{shipmentId:e.shipmentId},query:{MarketplaceId:this._getMarketplaceId(e.marketplaceCountry)}})),r=a.itemData.map((e=>e.fulfillmentNetworkSKU)),n={credentials:e.credentials,marketplaceCountry:e.marketplaceCountry,marketplaceSkus:r},i=await this.getProducts(n);return a.itemData.map((e=>{const t=i.find((t=>t.asin===e.fulfillmentNetworkSKU));return{shipmentId:e.shipmentId,sellerSKU:e.sellerSKU,quantityShipped:e.quantityShipped,quantityReceived:e.quantityReceived,quantityInCase:e.quantityInCase,prepDetailsList:e.prepDetailsList,marketplaceSKU:t.asin,identifiers:t.identifiers,images:t.images,ranks:t.ranks,salesRanks:t.salesRanks,summaries:t.summaries,variations:t.variations}}))}async getLabels(e){if(!s(e))throw new Error("parameters are from unexpected type or undefined");const t=this._initSellingPartnerObject(e.credentials.refreshToken);try{const a={operation:"fulfillmentInbound.getLabels"};Object.assign(a,{path:{shipmentId:e.shipmentId},query:{PageType:e.pageType,LabelType:e.labelType,PageSize:e.pageSize,PageStartIndex:e.pageStartIndex}});return p(await t.callAPI(a))}catch(e){return console.log(e),null}}}const T=b((function(e){return new(r())({region:"na",refresh_token:e})}),{maxAge:18e5});module.exports=t})();